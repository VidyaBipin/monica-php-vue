jobs:
- job: tests_browser
  pool:
    vmImage: 'ubuntu-latest'
  steps:
  - template: prepare-environment-step.yml
  - template: composer-install-step.yml
  - template: prepare-db-step.yml
  - template: seed-test-db-step.yml

  - bash: |
      /usr/bin/google-chrome --headless --disable-gpu --disable-dev-shm-usage --remote-debugging-port=9222 http://localhost &
    displayName: 'run google chrome'
  - bash: |
      composer require enm1989/chromedriver:73.0
      vendor/bin/chromedriver &
    displayName: 'Run selenium chromedriver'
#    - bash: scripts/tests/start-selenium.sh
#      displayName: 'Run selenium chromedriver'

  - bash: |
      php -S localhost:8000 -t public scripts/tests/server-cc.php &
      php -S localhost:8001 -t public scripts/tests/server-cc.php &
    displayName: 'Run http server'
#  - bash: until $(nc -z localhost 8000); do sleep 1; done
#    displayName: 'Wait for http server'
#  - bash: until $(nc -z localhost 8001); do sleep 1; done
#    displayName: 'Wait for http server'

  - bash: php artisan dusk --log-junit results/junit/dusk/results.xml
    displayName: 'Run browser tests'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFormat: JUnit
      testResultsFiles: 'results*.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)/results/junit/dusk'
      mergeTestResults: true
    condition: succeededOrFailed()

  - bash: |
      vendor/bin/phpcov merge --clover=results/coverage.xml results/coverage/
      rm -rf results/coverage
    displayName: 'Fix coverage'

  - task: PublishPipelineArtifact@0
    inputs:
      artifactName: 'results'
      targetPath: 'results'
